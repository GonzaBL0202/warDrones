<!DOCTYPE html>
<html lang="en">

<head>
    <title>Cargar Partida</title>
    <link rel="stylesheet" href="../css/fondo.css">
    <link rel="stylesheet" href="../css/botom.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jacquard+12&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/fuente.css">
</head>

<body style="display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0;">
    <section
        style="position: relative; width: 420px; height: 420px; display: flex; align-items: center; justify-content: center;">
        <img src="../img/gold_panel_8x.png" alt="Panel"
            style="position: absolute; inset: 0; width: 100%; height: 100%; image-rendering: pixelated;">

        <div
            style="position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 12px; width: 80%;">
            <h1 class="jacquard-12-regular" style="margin: 0 0 12px; font-size: 50px;">
                Cargar Partida
            </h1>

            <p class="jacquard-12-regular" style="margin: 0 0 8px; font-size: 20px; text-align:center;">
                Seleccioná una partida guardada:
            </p>

            <!-- Lista con scroll -->
            <div id="listaPartidas" class="jacquard-12-regular"
                style="width: 100%; max-height: 170px; overflow-y: auto; font-size: 18px; display: flex; flex-direction: column; gap: 8px;">
            </div>

            <!-- Botón Cargar -->
            <button id="btnCargar" class="boton" type="button"
                style="font-size: 20px; width: 190px; height: 42px; opacity: 0.6;" disabled>
                <span class="jacquard-12-regular">Cargar</span>
            </button>

            <form action="menu.html" method="get" style="margin:0;">
                <button class="boton" type="submit" style="font-size: 20px; width: 190px; height: 42px;">
                    <span class="jacquard-12-regular">Volver al Menu</span>
                </button>
            </form>
        </div>
    </section>

    <script>
        const API_URL = "http://localhost:8080";

        function getUserId() {
            return localStorage.getItem("userId");
        }

        const cont = document.getElementById("listaPartidas");
        const btnCargar = document.getElementById("btnCargar");

        let partidaSeleccionadaId = null;
        let ultimoBtnSeleccionado = null;

        function setCargarHabilitado(habilitado) {
            btnCargar.disabled = !habilitado;
            btnCargar.style.opacity = habilitado ? "1" : "0.6";
        }

        function seleccionarPartida(partidaId, btn) {
            partidaSeleccionadaId = partidaId;

            // “remarcar” selección (sin tocar CSS externo)
            if (ultimoBtnSeleccionado) {
                ultimoBtnSeleccionado.style.outline = "none";
                ultimoBtnSeleccionado.style.filter = "none";
            }
            btn.style.outline = "2px solid rgba(255,255,255,0.55)";
            btn.style.filter = "brightness(1.08)";
            ultimoBtnSeleccionado = btn;

            setCargarHabilitado(true);
        }

        async function cargarPartidas() {
            const userId = getUserId();
            if (!userId) {
                cont.innerHTML = "<div style='text-align:center;'>Usuario no logueado.</div>";
                setCargarHabilitado(false);
                return;
            }

            try {
                // GET /partidas/guardadas/{userId}  
                const response = await fetch(`${API_URL}/partidas/guardadas/${userId}`);

                if (!response.ok) {
                    const txt = await response.text();
                    cont.innerHTML = `<div style='text-align:center;'>Error al cargar partidas</div>`;
                    console.error("Backend:", txt);
                    setCargarHabilitado(false);
                    return;
                }

                const partidas = await response.json();

                cont.innerHTML = "";
                setCargarHabilitado(false);
                partidaSeleccionadaId = null;
                ultimoBtnSeleccionado = null;

                if (!Array.isArray(partidas) || partidas.length === 0) {
                    cont.innerHTML = "<div style='text-align:center;'>No hay partidas guardadas</div>";
                    return;
                }

                partidas.forEach(p => {
                    const id = p.partidaId ?? p.id;

                    const btn = document.createElement("button");
                    btn.className = "boton";
                    btn.type = "button";
                    btn.style.width = "100%";
                    btn.style.height = "42px";

                    btn.innerHTML = `<span class="jacquard-12-regular">Partida #${id}</span>`;

                    btn.addEventListener("click", () => seleccionarPartida(id, btn));

                    cont.appendChild(btn);
                });

            } catch (error) {
                console.error("Error:", error);
                cont.innerHTML = "<div style='text-align:center;'>Error al cargar partidas</div>";
                setCargarHabilitado(false);
            }
        }

        btnCargar.addEventListener("click", () => {
            if (!partidaSeleccionadaId) return;

            localStorage.setItem("partidaId", String(partidaSeleccionadaId));
            window.location.href = "lobby.html";
        });

        cargarPartidas();
    </script>
</body>

</html>