<!DOCTYPE html>
<html lang="en">

<head>
    <title>Nueva Partida</title>
    <link rel="stylesheet" href="../css/fondo.css">
    <link rel="stylesheet" href="../css/botom.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jacquard+12&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/fuente.css">
</head>

<body style="display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0;">
    <section
        style="position: relative; width: 420px; height: 420px; display: flex; align-items: center; justify-content: center;">
        <img src="../img/gold_panel_8x.png" alt="Panel"
            style="position: absolute; inset: 0; width: 100%; height: 100%; image-rendering: pixelated;">
        <div
            style="position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 12px;">
            <h1 class="jacquard-12-regular" style="margin: 0 0 12px; font-size: 50PX;">Crear Partida</h1>

            <button id="btnIniciar" class="boton" type="submit"
                style="font-size: 20px; width: 190px; height: 42px;"><span
                    class="jacquard-12-regular">Entrar</span></button>

                    
            <button id="btnCancelar" class="boton" type="button"
                style="font-size: 20px; width: 190px; height: 42px;"><span
                    class="jacquard-12-regular">Cancelar</span></button>
        </div>
    </section>
    <script>
        const API_URL = 'http://localhost:8080';
        const userId = localStorage.getItem('userId');

        document.getElementById('btnCancelar').onclick = () => {
            window.location.href = 'menu.html';
        };

        function getId() {
            const id = localStorage.getItem('userId');
            return id ? parseInt(id) : null;
        }
        document.getElementById('btnIniciar').addEventListener('click', async () => {
            if (!userId) {
                alert('Usuario no logueado.');
                window.location.href = '../index.html';
                return;
            }

            try{
                const response = await fetch(`${API_URL}/partidas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuarioId: userId })
            });

            if (!response.ok) {
                const txt = await response.text();
                console.error('Error al crear partida:', txt);
                return;
            }
            const partida = await response.json();
            

            // Si la partida ya tiene usuario2 asignado y es este usuario, ir directo a la partida
                const currentUserId = getId();

                // Extraer usuario2 de la respuesta comprobando varias variantes de nombres y propiedades
                const usuario2 = partida.usuarioId2 || partida.partidaUsuarioId2 || partida.usuarioId_2 || partida.partidaUsuarioId_2 || partida.partidaUsuarioId2 || null;
                let usuario2Id = null;
                if (usuario2) {
                    usuario2Id = usuario2.id ?? usuario2.usuarioId ?? usuario2.userId ?? null;
                }
                
                if (usuario2Id && currentUserId && Number(usuario2Id) === Number(currentUserId)) {
                    window.location.href = 'partida.html';
                } else {
                    window.location.href = 'lobby.html';
                }
            } catch (error) {
                console.error('No se pudo crear la partida:', error);
            }
        });
    </script>
</body>


</html>